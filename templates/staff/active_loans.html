{% extends 'base.html' %}

{% block title %}Активные выдачи{% endblock %}

{% block content %}
<h2 class="mb-4"><i class="fas fa-book-reader me-2"></i>Активные и просроченные выдачи</h2>

{# Search and Filter Form #}
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <form method="get" action="" class="row g-3 align-items-center">
            <div class="col-md-6 col-lg-4">
                <label for="search-input" class="visually-hidden">Поиск</label>
                <input type="text" name="search" id="search-input" class="form-control form-control-sm" placeholder="Поиск по читателю, книге..." value="{{ search_query|default:'' }}">
            </div>
            <div class="col-md-4 col-lg-3">
                <label for="status-select" class="visually-hidden">Статус</label>
                <select name="status" id="status-select" class="form-select form-select-sm">
                    <option value="" {% if not status_filter %}selected{% endif %}>Все статусы</option>
                    <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Только активные</option>
                    <option value="overdue" {% if status_filter == 'overdue' %}selected{% endif %}>Только просроченные</option>
                </select>
            </div>
            <div class="col-md-2 col-lg-auto">
                <button type="submit" class="btn btn-secondary btn-sm w-100"><i class="fas fa-search me-1"></i>Найти</button>
            </div>
        </form>
    </div>
</div>

{# Loans Table #}
{% if loans %}
    <form method="post" action="{% url 'staff_return_multiple' %}" id="return-form">
        {% csrf_token %}
        <div class="card shadow-sm mb-4">
            <div class="card-body p-0"> {# Remove padding for full-width table #}
                <div class="table-responsive"> 
                    <table class="table table-striped table-hover table-bordered table-sm mb-0"> 
                        <thead class="table-light">
                            <tr>
                                <th style="width: 30px;"><input type="checkbox" id="select-all-loans" class="form-check-input mx-auto d-block"></th>
                                <th><i class="fas fa-user me-1"></i>Читатель</th>
                                <th><i class="fas fa-book me-1"></i>Книга</th>
                                <th>Инв. номер</th>
                                <th><i class="fas fa-map-marker-alt me-1"></i>Пункт выдачи</th>
                                <th><i class="far fa-calendar-alt me-1"></i>Дата выдачи</th>
                                <th><i class="far fa-calendar-times me-1"></i>Срок возврата</th>
                                <th><i class="fas fa-info-circle me-1"></i>Статус</th>
                                <th style="width: 100px;">Действие</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for loan in loans %}
                            <tr class="{% if loan.loan_status == 'overdue' %}table-danger{% endif %}">
                                <td class="text-center"><input type="checkbox" name="loan_ids" value="{{ loan.loan_id }}" class="loan-checkbox form-check-input"></td> 
                                <td>
                                    {% if loan.reader.user %}
                                        {{ loan.reader.user.get_full_name|default:loan.reader.user.username }}
                                    {% else %}
                                        {{ loan.reader.first_name }} {{ loan.reader.last_name }}
                                    {% endif %}
                                    <small class="text-muted d-block">({{ loan.reader.library_card_number }})</small>
                                </td>
                                <td>{{ loan.copy.book.book_title }}</td>
                                <td>{{ loan.copy.inventory_number }}</td>
                                <td>{{ loan.location.location_name }}</td>
                                <td>{{ loan.loan_date|date:"d.m.Y" }}</td>
                                <td>{{ loan.due_date|date:"d.m.Y" }}</td>
                                <td>
                                    <span class="badge {% if loan.loan_status == 'overdue' %}bg-danger{% elif loan.loan_status == 'active' %}bg-success{% else %}bg-secondary{% endif %}">
                                        {{ loan.get_loan_status_display }}
                                    </span>
                                </td>
                                <td class="text-center">
                                    {# Individual return button #}
                                    <form action="{% url 'staff_return_book' loan.loan_id %}" method="post" style="display: inline;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-warning btn-sm" title="Вернуть эту книгу">
                                            <i class="fas fa-undo"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div> {# End card-body #}
        </div> {# End card #}
        <button type="submit" class="btn btn-danger mt-3"><i class="fas fa-undo me-1"></i>Вернуть выбранные</button> 
    </form>

    {# JavaScript for select all checkbox #}
    {% block extra_js %}
    <script>
        document.getElementById('select-all-loans').addEventListener('change', function(event) {
            var checkboxes = document.querySelectorAll('.loan-checkbox');
            checkboxes.forEach(function(checkbox) {
                checkbox.checked = event.target.checked;
            });
        });
    </script>
    {% endblock %}

{% else %}
    <div class="alert alert-info"><i class="fas fa-info-circle me-1"></i>Нет выдач, соответствующих вашему запросу.</div>
{% endif %}

{% endblock %} 