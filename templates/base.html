<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Библиотека{% endblock %}</title>
    {# Bootstrap 5 CSS #}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    {# jQuery (required by Select2) #}
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    {# Include form media CSS (like Select2) #}
    {% if form.media %}
        {{ form.media.css }}
    {% endif %}
    {# Link Custom CSS (place after Bootstrap) #}
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/custom.css' %}">
    
    <style>
        /* Keep essential styles like body padding and Select2 overrides here */
        body { 
            padding-top: 70px; /* Adjust as needed for fixed navbar height */
            padding-bottom: 60px; /* Footer height */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        main.container {
            flex: 1; /* Allow main content to grow */
        }
        /* Select2 Bootstrap 5 overrides */
        .select2-container--default .select2-selection--single {
            height: calc(1.5em + .75rem + 2px); 
            padding: .375rem .75rem;
            border: 1px solid #ced4da;
            border-radius: .25rem;
            width: 100%; /* Ensure it takes available width */
        }
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 1.5em;
            padding-left: 0;
        }
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: calc(1.5em + .75rem);
            right: 0.5rem;
        }
        span.select2-container {
            width: 100% !important; 
        }

        /* Loading Overlay Styles */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7); 
            z-index: 1060; 
            display: none; 
            align-items: center;
            justify-content: center;
        }
        #loading-overlay.loading-active {
            display: flex; 
        }
        .footer {
            background-color: #f8f9fa; /* Light background for footer */
            padding: 1rem 0;
            margin-top: auto; /* Push footer to bottom */
            font-size: 0.9em;
            color: #6c757d; /* Muted text color */
        }
    </style>
</head>
<body>

    {# Loading Overlay Element #}
    <div id="loading-overlay">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    {# Navbar - Use navbar-dark for light text on dark background #}
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top shadow-sm">
        <div class="container-fluid">
            {# Added a simple book icon - using light color #}
            <a class="navbar-brand" href="{% url 'home' %}">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-book-half me-2" viewBox="0 0 16 16" style="color: white;">
                  <path d="M8.5 2.687c.654-.689 1.782-.886 3.112-.752 1.234.124 2.503.523 3.388 1.17.953.712 1.04 1.73.998 2.651l-.006.046a6.5 6.5 0 0 1-.019.12l-.007.054-.016.117.004.025a5 5 0 0 1 .023.137l.005.029-.003.018a4.5 4.5 0 0 1-.01.04z"/>
                  <path fill-rule="evenodd" d="M16 8c-.533 1.002-1.3 1.803-2.088 2.426A4.5 4.5 0 0 1 11.5 11a4.5 4.5 0 0 1-1.912-.311l-.004-.002-.002-.001-.001-.001c-.03-.01-.058-.02-.087-.03-.156-.054-.31-.115-.464-.18-.146-.062-.289-.128-.428-.198-.142-.07-.28-.143-.411-.223-.135-.082-.266-.166-.39-.252-.127-.087-.247-.176-.363-.265l-.002-.001a8.6 8.6 0 0 1-.44-.308c-.147-.11-.289-.225-.426-.345-.139-.123-.273-.251-.402-.381a.9.9 0 0 0-.404-.303.75.75 0 0 0-.111-.04c-.045-.014-.088-.027-.13-.039l-.01-.003c-.046-.013-.091-.026-.136-.038a3.6 3.6 0 0 0-.204-.049c-.06-.01-.118-.02-.177-.027l-.014-.002c-.06-.007-.119-.013-.178-.018a6.5 6.5 0 0 0-.15-.01-.16-.006-.223-.004h-.002c-.135-.002-.27-.002-.405-.002h-.001c-.138 0-.276.001-.414.003h-.001l-.002.001c-.145.003-.29.006-.435.01h-.001c-.15.004-.299.009-.447.014l-.001.001c-.155.005-.309.011-.462.018l-.001.001c-.158.007-.316.015-.473.023l-.002.001c-.163.008-.325.018-.487.028l-.002.001a5.2 5.2 0 0 1-.424.055c-.16.024-.318.05-.473.077l-.004.001c-.16.03-.318.06-.47.09l-.003.001a6.5 6.5 0 0 1-.463.12l-.002.001c-.16.04-.318.08-.47.123l-.003.001c-.156.043-.31.087-.458.132l-.002.001a5.1 5.1 0 0 1-.446.15c-.15.055-.295.112-.435.17l-.002.001c-.142.06-.28.12-.412.183l-.004.001c-.14.066-.275.133-.405.202l-.003.002a5 5 0 0 0-.48.286c-.147.103-.29.21-.427.32l-.005.004a4.4 4.4 0 0 0-.397.394l-.003.003c-.13.13-.255.262-.374.397l-.002.002a4.4 4.4 0 0 1-.35.41l-.002.003a4.4 4.4 0 0 0-.317.42l-.001.002a1 1 0 0 0-.28.431.9.9 0 0 0-.26.487c-.045.15-.085.3-.12.445l-.003.009c-.035.145-.065.29-.09.435l-.002.008c-.024.14-.043.28-.056.418l-.002.01c-.013.135-.02.27-.02.4V14a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2.5a.5.5 0 0 0-.5-.5zM1 1v13h14V2.5a1.5 1.5 0 0 0-1.5-1.5h-11A1.5 1.5 0 0 0 1 2.5V14z"/>
                </svg>
                Библиотека
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                     {# Navigation items based on role #}
                    {% if user.is_authenticated %}
                        {% with current_url_name=request.resolver_match.url_name %}
                        {% if user.role == 'admin' %}
                            <li class="nav-item"><a class="nav-link {% if current_url_name == 'admin_dashboard' %}active{% endif %}" href="{% url 'admin_dashboard' %}">Админ Панель</a></li>
                            <li class="nav-item"><a class="nav-link no-loader {% if current_url_name == 'admin_generate_report' %}active{% endif %}" href="{% url 'admin_generate_report' %}">Скачать Отчет</a></li>
                            {# Django Admin link is external-like, might not highlight easily #}
                            <li class="nav-item"><a class="nav-link" href="/admin/">Django Admin</a></li> 
                        {% endif %}
                        {% if user.role == 'staff' or user.role == 'admin' %}
                            <li class="nav-item"><a class="nav-link {% if current_url_name == 'staff_dashboard' %}active{% endif %}" href="{% url 'staff_dashboard' %}">Панель Персонала</a></li>
                            <li class="nav-item"><a class="nav-link {% if current_url_name == 'staff_manage_requests' %}active{% endif %}" href="{% url 'staff_manage_requests' %}">Упр. Запросами</a></li>
                            <li class="nav-item"><a class="nav-link {% if current_url_name == 'staff_manage_ill_requests' %}active{% endif %}" href="{% url 'staff_manage_ill_requests' %}">Упр. МБА</a></li>
                            <li class="nav-item"><a class="nav-link {% if current_url_name == 'staff_issue_book' %}active{% endif %}" href="{% url 'staff_issue_book' %}">Выдать Книгу</a></li>
                            <li class="nav-item"><a class="nav-link {% if current_url_name == 'staff_active_loans' %}active{% endif %}" href="{% url 'staff_active_loans' %}">Активные Выдачи</a></li>
                            <li class="nav-item"><a class="nav-link {% if current_url_name == 'manage_fines' %}active{% endif %}" href="{% url 'manage_fines' %}">Штрафы</a></li>
                        {% endif %}
                        {% if user.role == 'user' %}
                            <li class="nav-item"><a class="nav-link {% if current_url_name == 'user_dashboard' %}active{% endif %}" href="{% url 'user_dashboard' %}">Каталог Книг</a></li>
                            <li class="nav-item"><a class="nav-link {% if current_url_name == 'user_my_requests' or current_url_name == 'user_request_book' %}active{% endif %}" href="{% url 'user_my_requests' %}">Мои Запросы</a></li>
                            <li class="nav-item"><a class="nav-link {% if current_url_name == 'user_my_ill_requests' or current_url_name == 'user_create_ill_request' %}active{% endif %}" href="{% url 'user_my_ill_requests' %}">Мои Запросы МБА</a></li>
                            <li class="nav-item"><a class="nav-link {% if current_url_name == 'user_my_fines' %}active{% endif %}" href="{% url 'user_my_fines' %}">Мои Штрафы</a></li>
                        {% endif %}
                        {% endwith %}
                    {% endif %}
                </ul>
                <ul class="navbar-nav">
                    {% if user.is_authenticated %}
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarUserDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-person-circle me-1" viewBox="0 0 16 16">
                                  <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0"/>
                                  <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1"/>
                                </svg>
                                {{ user.username }}
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarUserDropdown">
                                <li>
                                    <form action="{% url 'logout' %}" method="post" class="d-inline" id="logout-form">
                                        {% csrf_token %}
                                        <button type="submit" class="dropdown-item">Выйти</button>
                                    </form>
                                </li>
                            </ul>
                        </li>
                    {% else %}
                        <li class="nav-item"><a class="nav-link" href="{% url 'login' %}">Войти</a></li>
                        <li class="nav-item"><a class="nav-link btn btn-success btn-sm ms-2" href="{% url 'register' %}">Регистрация</a></li> {# Changed to btn-success #}
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    {# Main content container #}
    <main class="container my-4">
        {# Bootstrap Alerts for Messages - Placed inside main container #}
        {% if messages %}
            <div class="messages-container mb-3">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        {% block content %}
        {# Page specific content goes here #}
        {% endblock %}
    </main>

    {# Footer #}
    <footer class="footer mt-auto py-3 bg-light">
      <div class="container text-center">
        <span class="text-muted">&copy; {% now "Y" %} Библиотечная Система. Все права защищены.</span>
      </div>
    </footer>

    {# Bootstrap 5 JS Bundle #}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    {# Include form media JS #}
    {% if form.media %}
        {{ form.media.js }}
    {% endif %}

    {# Loading Indicator JavaScript #}
    <script>
        const loadingOverlay = document.getElementById('loading-overlay');

        function showLoader() {
            if (loadingOverlay) {
                loadingOverlay.classList.add('loading-active');
            }
        }

        function hideLoader() {
             if (loadingOverlay) {
                loadingOverlay.classList.remove('loading-active');
            }
        }

        document.querySelectorAll('a.nav-link:not([data-bs-toggle="dropdown"]):not(.no-loader), a.btn:not(.no-loader), .table a:not([data-bs-toggle]):not(.no-loader), a.navbar-brand:not(.no-loader)').forEach(link => {
            link.addEventListener('click', function(event) {
                if (!link.target || link.target === '_self') {
                   if (!link.href.startsWith('#') && !link.href.startsWith('javascript:') && link.getAttribute('href') !== '#') {
                       setTimeout(showLoader, 50); 
                   }
                }
            });
        });

        document.querySelectorAll('form:not(#logout-form)').forEach(form => {
            form.addEventListener('submit', function() {
                 setTimeout(showLoader, 50); 
            });
        });

        window.addEventListener('pageshow', hideLoader);
        hideLoader(); 
    </script>

    {# Block for extra page-specific JS #}
    {% block extra_js %}{% endblock %}

</body>
</html>